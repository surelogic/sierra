<?xml version="1.0" encoding="UTF-8"?>
<project name="server-deployment" xmlns:flashlight="antlib:com.surelogic.flashlight.ant">
  <!-- NOTE: This script is included from .. so its paths are WRONG if it 
    is run directly from within the lib directory -->

  <description>Sierra server and portal Jetty with embedded Derby
    deployment</description>

  <!-- The path to the Jetty installation (usually the jetty project) -->
  <property name="jetty.dir" value="../jetty" />

  <property name="gwt.module" value="com.surelogic.sierra.gwt.SierraPortal" />

  <target name="deploy-site">
    <echo>Deploying Sierra Team Server to ${jetty.dir}</echo>
    <!-- Be sure to update undeploy-site with any changes made to the deployment -->
    <copy todir="${jetty.dir}/etc">
      <fileset file="./etc/sierra-embedded-derby.xml" />
      <fileset file="./etc/keystore" />
    </copy>
    <copy todir="${jetty.dir}/lib/ext">
      <fileset file="./lib/mail.jar" />
      <fileset dir="../../common/common/lib/runtime">
        <include name="derby*.jar" />
      </fileset>
    </copy>
    <copy todir="../sierra-portal/lib/web-dependencies">
      <fileset file="./lib/activation-1.1.jar" />
      <fileset dir="../sierra-portal-servlets/lib">
        <include name="*.jar" />
      </fileset>
      <fileset dir="../sierra-message/srpc">
        <include name="*.jar" />
      </fileset>
      <fileset dir="../sierra-portal/lib/gwt">
        <include name="gwt-user.jar" />
      </fileset>
      <fileset dir="../../common/common/lib/runtime">
        <include name="*.jar" />
        <exclude name="derby*.jar" />
      </fileset>
    </copy>
    <jar destfile="../sierra-portal/lib/web-dependencies/common.jar"
      basedir="../../common/common/bin" />
    <jar destfile="../sierra-portal/lib/web-dependencies/sierra-jdbc.jar"
      basedir="../sierra-jdbc/bin" />
    <jar destfile="../sierra-portal/lib/web-dependencies/sierra-jdbc-server.jar"
      basedir="../sierra-jdbc-server/bin" />
    <jar destfile="../sierra-portal/lib/web-dependencies/sierra-message.jar"
      basedir="../sierra-message/bin" />
    <jar
      destfile="../sierra-portal/lib/web-dependencies/sierra-portal-servlets.jar"
      basedir="../sierra-portal-servlets/bin" />

    <path id="gwt.class.path">
      <pathelement path="${java.class.path}/" />
      <pathelement location="../sierra-portal/src" />
      <fileset dir="../sierra-portal/lib/gwt">
        <include name="*.jar" />
      </fileset>
    </path>
    <delete dir="../sierra-portal/www" />
    <java classpathref="gwt.class.path" classname="com.google.gwt.dev.Compiler"
      fork="true" maxmemory="512m">
      <arg value="-localWorkers" />
      <arg value="2" />
      <arg value="-war" />
      <arg value="../sierra-portal/www" />
      <arg value="${gwt.module}" />
    </java>
    <war destfile="${jetty.dir}/webapps/sl.war" webxml="../sierra-portal/web.xml">
      <fileset
        dir="../sierra-portal/www/com.surelogic.sierra.gwt.SierraPortal" />
      <classes dir="../sierra-portal/bin" />
      <classes dir="../sierra-services/bin" />
      <lib dir="../sierra-portal/lib/web-dependencies" />
    </war>
    <war destfile="${jetty.dir}/webapps/root.war" webxml="./webroot/web.xml">
      <fileset dir="./webroot">
        <exclude name="web.xml" />
      </fileset>
    </war>
  </target>

  <target name="undeploy-site">
    <delete quiet="true">
      <fileset dir="${jetty.dir}/etc/">
        <include name="sierra-embedded-derby.xml" />
        <include name="./etc/keystore" />
      </fileset>
    </delete>
    <delete quiet="true">
      <fileset dir="${jetty.dir}/lib/ext/">
        <include name="mail.jar" />
        <include name="derby*.jar" />
      </fileset>
    </delete>
    <delete quiet="true">
      <fileset dir="${jetty.dir}/webapps">
        <include name="*.war" />
      </fileset>
    </delete>
    <delete quiet="true">
      <fileset dir="../sierra-portal/lib/web-dependencies">
        <include name="*.jar" />
      </fileset>
    </delete>
  </target>
</project>