<?xml version="1.0" encoding="UTF-8"?>
<project name="server-deployment">
	<description>Sierra server and portal Jetty with embedded Derby deployment</description>

	<target name="deploy-all" depends="deploy-app, deploy-root"/>
	
	<target name="deploy-app">
		<!-- Update undeploy-app with any changes made to the deployment -->
		<copy file="./etc/sierra-embedded-derby.xml" todir="../jetty/etc/" />
		<copy file="./etc/sierraRealm.properties" todir="../jetty/etc/" />
		<copy file="./lib/derby.jar" todir="../jetty/lib/ext/" />
		<copy file="./lib/derbyclient.jar" todir="../jetty/lib/ext/" />
		<jar destfile="../jetty/lib/ext/common.jar" basedir="../common/bin" />
		<jar destfile="../sierra-services/lib/web-dependencies/common.jar" basedir="../common/bin" />
		<jar destfile="../sierra-services/lib/web-dependencies/sierra-jdbc.jar" basedir="../sierra-jdbc/bin" />
		<jar destfile="../sierra-services/lib/web-dependencies/sierra-message.jar" basedir="../sierra-message/bin" />
		<war destfile="../jetty/webapps/sierra-services.war" webxml="../sierra-services/web.xml">
			<fileset dir="../sierra-services/www" />
			<classes dir="../sierra-services/bin" />
			<lib dir="../sierra-services/lib/web-dependencies" />
		</war>
		<jar destfile="../sierra-portal/lib/web-dependencies/sierra-jdbc.jar" basedir="../sierra-jdbc/bin" />
		<jar destfile="../sierra-portal/lib/web-dependencies/sierra-message.jar" basedir="../sierra-message/bin" />
		<jar destfile="../sierra-portal/lib/web-dependencies/sierra-portal-servlets.jar" basedir="../sierra-portal-servlets/bin" />
		<path id="gwt.class.path">
			<pathelement path="${java.class.path}/" />
			<pathelement location="../sierra-portal/src" />
			<pathelement path="../sierra-portal/lib/gwt/gwt-user.jar" />
			<pathelement path="../sierra-portal/lib/gwt/gwt-dev-linux.jar" />
		</path>
		<java classpathref="gwt.class.path" classname="com.google.gwt.dev.GWTCompiler" fork="true">
			<arg value="-out" />
			<arg value="../sierra-portal/www" />
			<arg value="com.surelogic.sierra.gwt.SierraPortal" />
		</java>
		<war destfile="../jetty/webapps/sierra-portal.war" webxml="../sierra-portal/web.xml">
			<fileset dir="../sierra-portal/www/com.surelogic.sierra.gwt.SierraPortal" />
			<classes dir="../sierra-portal/bin" />
			<lib dir="../sierra-portal/lib/web-dependencies" />
		</war>
	</target>
	
	<target name="deploy-root">
		<war destfile="../jetty/webapps/root.war" webxml="./webroot/web.xml">
			<fileset dir="./webroot">
			    <exclude name="web.xml"/>
			</fileset>
		</war>
	</target>

	<target name="undeploy-all" depends="undeploy-app, undeploy-root"/>
	
	<target name="undeploy-app">
		<delete quiet="true" file="../jetty/etc/sierra-embedded-derby.xml" />
		<delete quiet="true" file="../jetty/etc/sierraRealm.properties" />
		<delete quiet="true" file="../jetty/lib/ext/derby.jar" />
		<delete quiet="true" file="../jetty/lib/ext/derbyclient.jar" />
		<delete quiet="true" file="../jetty/lib/ext/common.jar" />
		<delete quiet="true" file="../sierra-services/lib/web-dependencies/common.jar" />
		<delete quiet="true" file="../sierra-services/lib/web-dependencies/sierra-jdbc.jar" />
		<delete quiet="true" file="../sierra-services/lib/web-dependencies/sierra-message.jar" />
		<delete quiet="true" file="../jetty/webapps/sierra-services.war" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-jdbc.jar" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-message.jar" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-portal-servlets.jar" />
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="../sierra-portal/www/com.surelogic.sierra.gwt.SierraPortal" includes="**/*" />
		</delete>
		<delete quiet="true" file="../jetty/webapps/sierra-portal.war" />
	</target>
	
	<target name="undeploy-root">
	    <delete quiet="true" file="../jetty/webapps/root.war" />
	</target>
</project>