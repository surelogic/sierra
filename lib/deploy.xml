<?xml version="1.0" encoding="UTF-8"?>
<project name="server-deployment">

	<!-- NOTE: This script is included from .. so its paths are WRONG if it is run directly -->

	<description>Sierra server and portal Jetty with embedded Derby deployment</description>

	<target name="deploy-site" depends="deploy-team-server, deploy-root" />

	<target name="deploy-team-server">
		<!-- Update undeploy-app with any changes made to the deployment -->
		<copy file="./etc/sierra-embedded-derby.xml" todir="../jetty/etc/" />
		<copy file="./lib/derby.jar" todir="../jetty/lib/ext/" />
		<copy file="./lib/derbyclient.jar" todir="../jetty/lib/ext/" />
		<jar destfile="../sierra-services/lib/web-dependencies/common.jar" basedir="../common/bin" />
		<jar destfile="../sierra-services/lib/web-dependencies/sierra-jdbc.jar" basedir="../sierra-jdbc/bin" />
		<jar destfile="../sierra-services/lib/web-dependencies/sierra-message.jar" basedir="../sierra-message/bin" />
		<war destfile="../jetty/webapps/services.war" webxml="../sierra-services/web.xml">
			<fileset dir="../sierra-services/www" />
			<classes dir="../sierra-services/bin" />
			<lib dir="../sierra-services/lib/web-dependencies" />
		</war>
		<jar destfile="../sierra-portal/lib/web-dependencies/common.jar" basedir="../common/bin" />
		<jar destfile="../sierra-portal/lib/web-dependencies/sierra-jdbc.jar" basedir="../sierra-jdbc/bin" />
		<jar destfile="../sierra-portal/lib/web-dependencies/sierra-message.jar" basedir="../sierra-message/bin" />
		<jar destfile="../sierra-portal/lib/web-dependencies/sierra-portal-servlets.jar" basedir="../sierra-portal-servlets/bin" />
		<path id="gwt.class.path">
			<pathelement path="${java.class.path}/" />
			<pathelement location="../sierra-portal/src" />
			<pathelement path="../sierra-portal/lib/gwt/gwt-user.jar" />
			<pathelement path="../sierra-portal/lib/gwt/gwt-dev-linux.jar" />
		</path>
		<java classpathref="gwt.class.path" classname="com.google.gwt.dev.GWTCompiler" fork="true">
			<arg value="-out" />
			<arg value="../sierra-portal/www" />
			<arg value="com.surelogic.sierra.gwt.SierraPortal" />
		</java>
		<war destfile="../jetty/webapps/portal.war" webxml="../sierra-portal/web.xml">
			<fileset dir="../sierra-portal/www/com.surelogic.sierra.gwt.SierraPortal" />
			<classes dir="../sierra-portal/bin" />
			<lib dir="../sierra-portal/lib/web-dependencies" />
		</war>
	</target>

	<target name="deploy-root">
		<war destfile="../jetty/webapps/root.war" webxml="./webroot/web.xml">
			<fileset dir="./webroot">
				<exclude name="web.xml" />
			</fileset>
		</war>
	</target>

	<!-- JAXB is not included in Java 5 JREs so we have to add it -->
	<target name="deploy-missing-java-5-libs">
		<copy file="../sierra-message/jaxb/activation.jar" todir="../jetty/lib/ext/" />
		<copy file="../sierra-message/jaxb/jaxb-api.jar" todir="../jetty/lib/ext/" />
		<copy file="../sierra-message/jaxb/jaxb-impl.jar" todir="../jetty/lib/ext/" />
		<copy file="../sierra-message/jaxb/jaxb-xjc.jar" todir="../jetty/lib/ext/" />
		<copy file="../sierra-message/jaxb/jaxb1-impl.jar" todir="../jetty/lib/ext/" />
		<copy file="../sierra-message/jaxb/jsr173_1.0_api.jar" todir="../jetty/lib/ext/" />
		<copy file="../sierra-message/jaxb/sjsxp.jar" todir="../jetty/lib/ext/" />
	</target>

	<target name="undeploy-site" depends="undeploy-team-server, undeploy-root" />

	<target name="undeploy-team-server">
		<delete quiet="true" file="../jetty/etc/sierra-embedded-derby.xml" />
		<delete quiet="true" file="../jetty/etc/sierraRealm.properties" />
		<delete quiet="true" file="../jetty/lib/ext/derby.jar" />
		<delete quiet="true" file="../jetty/lib/ext/derbyclient.jar" />
		<!-- ../jetty/lib/ext/common.jar is obsolete after Jan 08 -->
		<delete quiet="true" file="../jetty/lib/ext/common.jar" />

		<!-- If the deployment was Java 5 then we need to clean out JAXB libraries -->
		<delete quiet="true" file="../jetty/lib/ext/activation.jar" />
		<delete quiet="true" file="../jetty/lib/ext/jaxb-api.jar" />
		<delete quiet="true" file="../jetty/lib/ext/jaxb-impl.jar" />
		<delete quiet="true" file="../jetty/lib/ext/jaxb-xjc.jar" />
		<delete quiet="true" file="../jetty/lib/ext/jaxb1-impl.jar" />
		<delete quiet="true" file="../jetty/lib/ext/jsr173_1.0_api.jar" />
		<delete quiet="true" file="../jetty/lib/ext/sjsxp.jar" />

		<delete quiet="true" file="../sierra-services/lib/web-dependencies/common.jar" />
		<delete quiet="true" file="../sierra-services/lib/web-dependencies/sierra-jdbc.jar" />
		<delete quiet="true" file="../sierra-services/lib/web-dependencies/sierra-message.jar" />
		<!-- sierra-services.war is obsolete after Jan 31 -->
		<delete quiet="true" file="../jetty/webapps/sierra-services.war" />
		<delete quiet="true" file="../jetty/webapps/services.war" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/common.jar" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-jdbc.jar" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-message.jar" />
		<!-- sierra-portal-rpc.jar is obsolete after Jan 08 -->
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-portal-rpc.jar" />
		<delete quiet="true" file="../sierra-portal/lib/web-dependencies/sierra-portal-servlets.jar" />
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="../sierra-portal/www/com.surelogic.sierra.gwt.SierraPortal" includes="**/*" />
		</delete>
		<!-- sierra-portal.war is obsolete after Jan 31 -->
		<delete quiet="true" file="../jetty/webapps/sierra-portal.war" />
		<delete quiet="true" file="../jetty/webapps/portal.war" />
	</target>

	<target name="undeploy-root">
		<delete quiet="true" file="../jetty/webapps/root.war" />
	</target>
</project>